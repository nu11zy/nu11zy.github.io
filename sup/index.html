<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã –°–£–ü</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 16px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .subtitle {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 24px;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 12px;
            font-size: 20px;
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            letter-spacing: 2px;
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000000);
            transition: border-color 0.2s;
        }
        
        input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #0088cc);
        }
        
        .saved-indicator {
            text-align: center;
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .saved-indicator.show {
            opacity: 1;
        }
        
        .result {
            margin-top: 24px;
            padding: 20px;
            border-radius: 16px;
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            display: none;
        }
        
        .result.show {
            display: block;
        }
        
        .result h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .balance-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--tg-theme-button-color, #0088cc);
            text-align: center;
            padding: 20px 0;
        }
        
        .error {
            color: var(--tg-theme-destructive-text-color, #ff3b30);
            padding: 16px;
            border-radius: 12px;
            background-color: rgba(255, 59, 48, 0.1);
            margin-top: 16px;
            font-size: 14px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .history {
            margin-top: 24px;
        }
        
        .history h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .history-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-date {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 4px;
        }
        
        .history-amount {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .history-amount.credit {
            color: #34c759;
        }
        
        .history-amount.debit {
            color: #ff3b30;
        }
        
        .history-location {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí≥ –ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã –°–£–ü</h1>
        <p class="subtitle">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –≤–∞—à–µ–π –∫–∞—Ä—Ç—ã –ø–∏—Ç–∞–Ω–∏—è</p>
        
        <div class="input-group">
            <label for="cardInput">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
            <input 
                type="text" 
                id="cardInput" 
                placeholder="0-000000-000000"
                maxlength="15"
                inputmode="numeric"
                autocomplete="off">
            <div id="savedIndicator" class="saved-indicator">
                <span>‚úì</span>
                <span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
            </div>
        </div>
        
        <div id="error" class="error"></div>
        <div id="result" class="result"></div>
    </div>

    <script>
        const CORS_PROXY = 'https://api.codetabs.com/v1/proxy/?quest=';
        const API_BASE_URL = 'https://meal.gift-cards.ru/api/1/cards/';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        document.body.style.backgroundColor = tg.backgroundColor || 'var(--tg-theme-bg-color)';

        const storage = tg.CloudStorage;
        const cardInput = document.getElementById('cardInput');
        const savedIndicator = document.getElementById('savedIndicator');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        
        let saveTimeout;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        storage.getItem('card_number', (err, value) => {
            if (!err && value) {
                cardInput.value = value;
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã');
            }
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        tg.MainButton.setText('–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å');
        tg.MainButton.color = tg.themeParams.button_color || '#0088cc';
        tg.MainButton.textColor = tg.themeParams.button_text_color || '#ffffff';
        tg.MainButton.show();
        tg.MainButton.onClick(checkBalance);

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –º–∞—Å–∫–æ–π –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        cardInput.addEventListener('input', function(e) {
            hideError();
            
            let value = e.target.value.replace(/\D/g, '');
            
            // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞—Å–∫–∏ 0-000000-000000
            let formatted = '';
            if (value.length > 0) {
                formatted = value.substring(0, 1);
                if (value.length > 1) {
                    formatted += '-' + value.substring(1, 7);
                }
                if (value.length > 7) {
                    formatted += '-' + value.substring(7, 13);
                }
            }
            
            e.target.value = formatted;

            // Debounce —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            clearTimeout(saveTimeout);
            
            if (formatted.length > 0) {
                saveTimeout = setTimeout(() => {
                    storage.setItem('card_number', formatted, (err, saved) => {
                        if (!err && saved) {
                            showSavedIndicator();
                            tg.HapticFeedback.impactOccurred('light');
                        }
                    });
                }, 500);
            }
        });

        function showSavedIndicator() {
            savedIndicator.classList.add('show');
            setTimeout(() => {
                savedIndicator.classList.remove('show');
            }, 1500);
        }

        function hideError() {
            errorDiv.classList.remove('show');
            errorDiv.textContent = '';
        }

        function showError(message) {
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.classList.add('show');
            resultDiv.classList.remove('show');
            tg.HapticFeedback.notificationOccurred('error');
        }

        async function checkBalance() {
            const cardNumber = cardInput.value.replace(/\D/g, '');
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!cardNumber) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã');
                return;
            }
            
            if (cardNumber.length !== 13) {
                tg.showAlert('–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 13 —Ü–∏—Ñ—Ä');
                return;
            }

            hideError();
            resultDiv.classList.remove('show');
            tg.MainButton.showProgress();
            
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ CORS –ø—Ä–æ–∫—Å–∏
                const apiUrl = `${API_BASE_URL}${cardNumber}`;
                const proxyUrl = `${CORS_PROXY}${encodeURIComponent(apiUrl)}?limit=100`;
                
                console.log('–ó–∞–ø—Ä–æ—Å –∫:', proxyUrl);
                
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
                if (data.status !== 'OK' || !data.data) {
                    throw new Error('–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                }

                const cardData = data.data;
                const balance = cardData.balance?.availableAmount || 0;
                const phone = cardData.phone || '–ù–µ —É–∫–∞–∑–∞–Ω';
                const cardType = cardData.cardType || 'food';
                const history = cardData.history || [];
                
                // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ HTML —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                let html = `
                    <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç–µ</h2>
                    <div class="info-row">
                        <span class="info-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</span>
                        <span class="info-value">${formatCardNumber(cardNumber)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                        <span class="info-value">${phone}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–¢–∏–ø –∫–∞—Ä—Ç—ã</span>
                        <span class="info-value">${cardType === 'food' ? '–ü–∏—Ç–∞–Ω–∏–µ' : cardType}</span>
                    </div>
                    <div class="balance-amount">${balance.toFixed(2)} ‚ÇΩ</div>
                `;
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
                if (history.length > 0) {
                    html += '<div class="history"><h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>';
                    
                    history.slice(0, 10).forEach(item => {
                        const date = new Date(item.time);
                        const dateStr = date.toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const amount = Math.abs(item.amount);
                        const location = (item.locationName && item.locationName[0]) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                        const className = item.credit ? 'credit' : 'debit';
                        const sign = item.credit ? '+' : '-';
                        
                        html += `
                            <div class="history-item">
                                <div class="history-date">${dateStr}</div>
                                <div class="history-amount ${className}">${sign}${amount} ‚ÇΩ</div>
                                <div class="history-location">${location}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                resultDiv.innerHTML = html;
                resultDiv.classList.add('show');
                
                tg.HapticFeedback.notificationOccurred('success');
                
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã.');
            } finally {
                tg.MainButton.hideProgress();
            }
        }

        function formatCardNumber(cardNumber) {
            return cardNumber.substring(0, 1) + '-' + 
                   cardNumber.substring(1, 7) + '-' + 
                   cardNumber.substring(7, 13);
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log('Telegram WebApp initialized');
        console.log('User ID:', tg.initDataUnsafe?.user?.id);
        console.log('Theme:', tg.themeParams);
    </script>
</body>
</html>
